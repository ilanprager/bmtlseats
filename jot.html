<html>

<head>

<title>BMTL Seating Widget </title>

<script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
<script src="js/SeatingGrid.js"></script>

<style>
body {
    font-family: Arial, Helvetica, sans-serif;
}

.gridTitle {
    width: 600px;
    text-align: center;
    font-weight: bold;
    margin-bottom: 4px;
}
    
.gridSeparator {
    height: 10px;
}
    
.seatingGrid {
    width: 600px;
    border: 1px solid black;
    border-collapse: collapse;
}
    
.seatingGrid td {
    width: 20px;
    height: 20px;
    border: 1px solid lightgray;
    padding: 0px;
    margin: 0px;
    font-size: 9pt;
}
    
.seat {
    cursor: pointer;
}
    
.shulchan, .bimah {
    background-color: lightgray;
}

.pole {
    background-color: darkgray;
}
    
.rabbi {
    background-color: lightgray;
}
    
.rowHeader, .colHeader {
    text-align: center;
}
    
.choice-0 {
    background-image: url("images/one.svg") !important;
    background-size: 18px !important;
    background-repeat: no-repeat;
    background-position-x: center; 
    background-position-y: center;
}
    
.choice-1 {
    background-image: url("images/two.svg") !important;
    background-size: 18px !important;
    background-repeat: no-repeat;
    background-position-x: center; 
    background-position-y: center; 
}
        
.seat.men {
    background-color: #E5EFFF;
    background-image: url("images/seat.svg");
    background-size: 16px;
    background-repeat: no-repeat;
    background-position-x: center;
    background-position-y: center;
}
    
.seat.women {
    background-color: #FFE5FE;
    background-image: url("images/seat.svg");
    background-size: 16px;
    background-repeat: no-repeat;
    background-position-x: center;
    background-position-y: center;
}

.seat.plastic {
    background-image: url("images/seat-plastic.svg");
    background-size: 16px;
    background-repeat: no-repeat;
    background-position-x: center;
    background-position-y: center;
}
    
.mechitzahorizontal {
    border-bottom: 4px solid brown !important;
}

.mechitzavertical {
    border-right: 4px solid brown !important;
}
    
.legend {
    font-size: 9pt;
    margin-bottom: 10px;
}
.legendCell {
    width: 20px;
    height: 20px;
}
.legendLabel {
    padding-right: 20px;
}

.legendCell.seat.men {
    background-color: #FFFFFF !important;
}
    
.bimahLabel {
    position: absolute;
    top: 180px;
    left: 275px;
    font-size: 9pt;
}
</style>
    
<script>    
// numRows: number of total grid rows including headers
// numCols: number of total grid columns including headers
// startRowCode: letter code at which to start grid rows
// startRowCodeIndex: zero based index at which to start labeling rows
// startColumnCodeIndex: zero based index at which to start labeling columns
// codeColumnsIndexes: array of zero based columns indexes where numbers should appear    
// numChoices: number of choices (e.g. choose 1st and 2nd preference for seats == 2)
// seatRegions: array of region names that should be recognized as seats (e.g. ["men", "women"])
var lowerConfig = {
    numRows: 22,
    numCols: 28,
    startRowCode: "A",
    startRowIndex: 2,
    startColumnCodeIndex: 1,
    codeColumnsIndexes: [0, 27],  
    numChoices: 2,
    seatRegions: ["men", "women", "plastic"],
    regions: {
        men: ["A1:C5", "D2:D5", "B7:B8", "C7:F10", "C17:F20", "A21:A26", "B22:F26", "G2:G5", "H2:I8",
               "J2:J4", "J6:J8", "K2:K8", "H10:N16", "H18:I25", "J18:J21", "J24:J25",
               "K18:M25"],
        women: ["M2:M7", "N3:N7", "P10:P12", "Q9:T12", "P15:R20", "S15:S18", "T15:T16", "P23:Q25", "R23:S26"],
        shulchan: ["C11:F16"],
        bimah: ["@10:@17","@20", "A13:A14"],
        pole: ["@1", "@26", "J5", "J22:J23"],
        rabbi: ["@19:A19"],
        plastic: ["M2:M7", "P10:P12", "Q9:T12", "P15:R20", "S15:S18", "T15:T16", "P23:Q25", "R23:S26"],
        mechitzahorizontal: ["L1:L7","O8:O26"],
        mechitzavertical: ["M7:O7"]
    }
};
    
var upperConfig = {
    numRows: 25,
    numCols: 30,
    startRowCode: "U",
    startRowIndex: 2,
    startColumnCodeIndex: 1,
    codeColumnsIndexes: [0, 29],
    numChoices: 2,
    seatRegions: ["men", "women", "plastic"],
    regions: {
        women: ["U2:Y3", "AA2:AE3", "AG2:AK3", "U26:Y27", "AA26:AE27", "AG26:AK27", "AL27", "AM5:AP10", "AN1:AP3", "AM12:AP17", "AM19:AP24", "AO26:AQ28"],
        plastic: ["AP5:AP10", "AO26:AQ28"],
        mechitzahorizontal: ["AL4:AL25"],
        mechitzavertical: ["U3:AL3", "U25:AL25"]
    }
};
</script>
</head>
<body>
    <table class="legend">
    <tr>
        <td class="legendCell seat men"></td><td class="legendLabel">Regular רגיל</td>
        <td class="legendCell seat plastic"></td><td class="legendLabel">Plastic פלסטיק</td>
        <td class="legendCell seat choice-0"></td><td class="legendLabel">1st Choice עדיפות ראשונה</td>
        <td class="legendCell seat choice-1"></td><td class="legendLabel">2nd Choice עדיפות שניה</td>
    </tr>
    </table>
    <div class="gridTitle">Ground Floor קומת כניסה</div>
    <div id="lowerLevelContainer"></div>
    <div class="gridSeparator"></div>
    <div class="gridTitle">Upper Floor קומת עליונה</div>
    <div id="upperLevelContainer"></div>
    <div class="bimahLabel">Bimah בימה</div>
</body>
<script>
function aggregateStatuses(statuses) {
    var nameMap = ["1st","2nd","3rd","4th","5th"];
    var aggregate = {
        seatChoices: {}    
    };
    statuses.forEach(function(status) {
        for(var choiceKey in status.seatChoices) {
            var choices = status.seatChoices[choiceKey];
            var aggChoices = aggregate.seatChoices[choiceKey];
            if (!aggChoices) {
                aggChoices = [];
                aggregate.seatChoices[choiceKey] = aggChoices;
            }
            choices.forEach(function(choice) {
                aggChoices.push(choice);
            });
        }
    });
    for(var choiceKey in aggregate.seatChoices) {
    	var choices = aggregate.seatChoices[choiceKey];
    	delete aggregate.seatChoices[choiceKey];
        aggregate.seatChoices[nameMap[choiceKey]] = choices.join(",");
    }
    return aggregate;
};

function getCurrentWidgetStatus() {
    var lowerStatus = lowerGrid.getStatus();
    var upperStatus = upperGrid.getStatus();
    var aggregate = aggregateStatuses([lowerStatus, upperStatus]);
    var hasChoices = false;
    for(var choiceKey in aggregate.seatChoices) {
        if (aggregate.seatChoices[choiceKey] != "") {
            hasChoices = true;
            break;
        }
    }
    if (!hasChoices) {
        aggregate.empty = true;
    }
    return aggregate;
}
    
function pushChanges() {
    var status = getCurrentWidgetStatus();        
    var value = status.empty ? null : JSON.stringify(status);
    JFCustomWidget.sendData(getCurrentWidgetStatus());
    console.log(getCurrentWidgetStatus());
}

var lowerGrid = new SeatingGrid(lowerConfig);
var upperGrid = new SeatingGrid(upperConfig);
    
lowerGrid.on("change", pushChanges);
upperGrid.on("change", pushChanges);
    
document.getElementById("lowerLevelContainer").appendChild(lowerGrid.createGrid());
document.getElementById("upperLevelContainer").appendChild(upperGrid.createGrid());


JFCustomWidget.subscribe("ready", function(){
    JFCustomWidget.subscribe("submit", function() {
        var status = getCurrentWidgetStatus();        
        var value = status.empty ? null : JSON.stringify(status);  
        JFCustomWidget.sendSubmit({
            valid: value != null,
            value: value
        });
    });
});
</script>
</html>
